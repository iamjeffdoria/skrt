{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-light text-dark p-4" style="font-family: 'Poppins', sans-serif;">
    <div class="container">
        <div class="text-center mb-5" style="color: #333; position: relative;">
            <img src="{% static 'img/pitLOGO.png' %}" alt="Logo Left" class="logo position-absolute" style="width: 100px; left: 10px; top: 10px;">
            <h1>Palompon Institute of Technology</h1>
            <p class="address text-muted" style="margin-top: -5px;">Evangelista St. Palompon Leyte</p>
            <img src="{% static 'img/newcote.png' %}" alt="Logo Right" class="logo position-absolute" style="width: 100px; right: 10px; top: 10px;">
        </div>

        <div class="bg-white p-3 mb-3 rounded shadow">
            <h2>Current Student</h2>
            <table class="table table-dark table-striped">
                <tr>
                    <td rowspan="5" class="text-center align-middle">
                        <img id="student-pic" class="img-fluid rounded" src="" alt="Profile Picture" style="width: 180px; height: 180px; object-fit: cover; border: 3px solid #333;">
                    </td>
                    <th>Name</th>
                    <td id="student-name"></td>
                </tr>
                <tr>
                    <th>Major</th>
                    <td id="student-major"></td>
                </tr>
                <tr>
                    <th>Status</th>
                    <td id="student-type"></td>
                </tr>
                <tr>
                    <th>Date</th>
                    <td id="student-date"></td>
                </tr>
                <tr>
                    <th>Time</th>
                    <td id="student-time"></td>
                </tr>
            </table>
        </div>

        <div class="bg-white p-3 mb-3 rounded shadow">
            <h2>Recent Students</h2>
            <div class="d-flex flex-wrap" id="recent-log-container">
                <!-- Recent log student profile pictures will be displayed here -->
            </div>
        </div>

        <!-- Hidden RFID input field -->
        <input type="text" id="rfid-input" class="form-control position-absolute" placeholder="Scan or enter RFID number" style="left: -9999px;">
    </div>

    <!-- Time and Date at the Bottom -->
    <div id="current-time" class="dynamic-time text-center mt-4" style="font-size: 1.5em; font-weight: bold; color: #333;"></div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        function updateDashboard(data) {
            $('#student-name').text(`${data.first_name} ${data.middle_name || ''} ${data.last_name} ${data.suffix || ''}`);
            $('#student-major').text(data.major);
            $('#student-type').html(`<span class="${data.type === 'login' ? 'text-success' : 'text-danger'}">${data.type.charAt(0).toUpperCase() + data.type.slice(1)}</span>`);
            $('#student-time').text(data.time);
            $('#student-date').text(data.date);
            $('#student-pic').attr('src', data.picture || '/static/default.png');

            const recentLogsContainer = $('#recent-log-container');
            recentLogsContainer.empty();

            data.recent_logs.forEach(log => {
                recentLogsContainer.append(
                    `<img src="${log.student.picture || '/static/default.png'}" class="rounded-circle" style="width: 70px; height: 70px; object-fit: cover; margin-right: 10px; border: 2px solid #333;" alt="Recent Log Student Picture">`
                );
            });

            // Show Toastify notification for login
            if (data.type === 'login') {
                Toastify({
                    text: "Student logged in successfully!",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#4CAF50",
                    stopOnFocus: true
                }).showToast();
            } else {
                // Show Toastify notification for logout
                Toastify({
                    text: "Student logged out successfully!",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#FF5A5F",
                    stopOnFocus: true
                }).showToast();
            }
        }

        function updateTime() {
            const now = new Date();
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            };
            const timeOptions = { 
                hour: 'numeric', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: true 
            };
            
            const formattedDate = now.toLocaleDateString('en-US', dateOptions);
            const formattedTime = now.toLocaleTimeString('en-US', timeOptions).toLowerCase();

            $('#current-time').html(`${formattedDate}<br><div style="font-size: 2em; font-weight: bold;">${formattedTime}</div>`);
        }

        $(document).ready(function () {
            $('#rfid-input').focus();

            $('#rfid-input').on('keydown', function (e) {
                if (e.keyCode === 13) {
                    const rfid_number = $(this).val().trim();
                    if (rfid_number) {
                        $.post('/process-rfid/', { 'rfid_number': rfid_number }, function (response) {
                            if (response.status === 'success') {
                                updateDashboard(response.data);
                                $('#rfid-input').val('').focus();
                            } else {
                                // Show Toastify notification if RFID is not found
                                Toastify({
                                    text: response.message || "RFID not recognized",
                                    duration: 3000,
                                    close: true,
                                    gravity: "top",
                                    position: "center",
                                    backgroundColor: "#FF5A5F",
                                    stopOnFocus: true
                                }).showToast();
                                $('#rfid-input').val('').focus();
                            }
                        });
                    } else {
                        $('#rfid-input').val('').focus();
                    }
                }
            });

            updateTime(); // Update time initially
            setInterval(updateTime, 1000); // Update time every second
        });
    </script>
</body>
</html>
